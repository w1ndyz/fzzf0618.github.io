I"–(<h4 id="portainer">Portainer</h4>

<p>åœ¨ä½¿ç”¨Docker swarméƒ¨ç½²é¡¹ç›®æ—¶ï¼Œæˆ‘ä»¬å…ˆè¦äº†è§£ä¸€ä¸ªå·¥å…·â€“<a href="https://github.com/portainer/portainer">Portainer</a>ã€‚</p>

<p>Portaineræ˜¯ä¸€ä¸ªè½»é‡çº§çš„ç®¡ç†Dockerçš„UIã€‚ä»–å…è®¸æˆ‘ä»¬ç®¡ç†æ‰€æœ‰çš„Dockerèµ„æº(å®¹å™¨ï¼Œæ˜ åƒï¼Œå·ï¼Œç½‘ç»œç­‰)ã€‚ä»–ä¸ç‹¬ç«‹çš„Dockerå¼•æ“å’ŒDocker Swarmæ¨¡å¼å…¼å®¹ã€‚</p>

<h4 id="docker-swarm">Docker Swarm</h4>

<p>Docker Swarm æ˜¯Dockerå¼•æ“å†…ç½®(åŸç”Ÿ)çš„é›†ç¾¤ç®¡ç†å’Œç¼–æ’å·¥å…·ã€‚</p>

<p>ä½¿ç”¨ <code class="highlighter-rouge">Swarm</code> é›†ç¾¤ä¹‹å‰éœ€è¦äº†è§£ä»¥ä¸‹å‡ ä¸ªæ¦‚å¿µã€‚</p>

<ul>
  <li>èŠ‚ç‚¹</li>
  <li>æœåŠ¡å’Œä»»åŠ¡</li>
</ul>

<p>èŠ‚ç‚¹åˆ†ä¸ºç®¡ç†(manager)èŠ‚ç‚¹å’Œå·¥ä½œ(worker)èŠ‚ç‚¹ã€‚ä¸€ä¸ªSwarmå¯ä»¥æœ‰å¤šä¸ªç®¡ç†èŠ‚ç‚¹ï¼Œä½†åªæœ‰ä¸€ä¸ªç®¡ç†èŠ‚ç‚¹å¯ä»¥æˆä¸º<code class="highlighter-rouge">leader</code>ï¼Œ<code class="highlighter-rouge">leader</code>é€šè¿‡<code class="highlighter-rouge">raft</code>åè®®å®ç°ã€‚å·¥ä½œèŠ‚ç‚¹æ˜¯ä»»åŠ¡æ‰§è¡Œçš„èŠ‚ç‚¹ï¼Œç®¡ç†èŠ‚ç‚¹å°†ä»»åŠ¡æˆ–æœåŠ¡(service)ä¸‹å‘åˆ°å·¥ä½œèŠ‚ç‚¹æ‰§è¡Œã€‚ç®¡ç†èŠ‚ç‚¹é»˜è®¤ä¹Ÿä½œä¸ºå·¥ä½œèŠ‚ç‚¹ã€‚ä¸‹é¢è¿™å¼ å›¾ç‰‡å±•ç¤ºäº†é›†ç¾¤ä¸­ç®¡ç†èŠ‚ç‚¹å’Œå·¥ä½œèŠ‚ç‚¹çš„å…³ç³»:</p>

<p><img src="/assets/swarm-diagram.png" alt="" /></p>

<p>ä»»åŠ¡(Task)æ˜¯Swarmä¸­çš„æœ€å°è°ƒåº¦å•ä½,ç›®å‰æ¥è¯´å°±æ˜¯ä¸€ä¸ªå•ä¸€çš„å®¹å™¨ã€‚</p>

<p>æœåŠ¡(Services)æ˜¯æŒ‡ä¸€ç»„ä»»åŠ¡çš„é›†åˆï¼ŒæœåŠ¡æœ‰ä¸¤ç§æ¨¡å¼:</p>

<ul>
  <li><code class="highlighter-rouge">replicated services</code> æŒ‰ç…§ä¸€å®šè§„åˆ™åœ¨å„ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡ŒæŒ‡å®šä¸ªæ•°çš„ä»»åŠ¡ã€‚</li>
  <li><code class="highlighter-rouge">global services</code> æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªä»»åŠ¡</li>
</ul>

<p>ä¸¤ç§æ¨¡å¼é€šè¿‡ <code class="highlighter-rouge">docker service create</code> çš„ <code class="highlighter-rouge">--mode</code> å‚æ•°æŒ‡å®šã€‚</p>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ¨¡æ‹ŸDocker Swarmçš„éƒ¨ç½²ï¼Œä»ä¸‹é¢çš„ç¤ºä¾‹æ¥è§‚å¯Ÿä¸€äº›ç»†èŠ‚ã€‚</p>

<h4 id="éƒ¨ç½²ç¤ºä¾‹">éƒ¨ç½²ç¤ºä¾‹</h4>

<p>å‰æœŸå‡†å¤‡:</p>

<ul>
  <li>webæœåŠ¡å™¨2å°</li>
  <li>æ•°æ®åº“1å°</li>
  <li>é˜Ÿåˆ—1å°</li>
</ul>

<h5 id="ä¸Šä¼ docker-composeåŠé…ç½®æ–‡ä»¶è‡³croné˜Ÿåˆ—æœåŠ¡å™¨å°†é˜Ÿåˆ—æœåŠ¡å™¨ä½œä¸ºswarmçš„managerèŠ‚ç‚¹">ä¸Šä¼ docker-composeåŠé…ç½®æ–‡ä»¶è‡³croné˜Ÿåˆ—æœåŠ¡å™¨ï¼Œå°†é˜Ÿåˆ—æœåŠ¡å™¨ä½œä¸ºswarmçš„managerèŠ‚ç‚¹ã€‚</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># æœ¬åœ°</span>
<span class="nv">$ </span>rsync app-docker.tar cron:/data/

<span class="c"># cronæœåŠ¡å™¨</span>
<span class="nv">$ </span><span class="nb">cd</span> /data
<span class="nv">$ </span><span class="nb">tar</span> <span class="nt">-xvf</span> app-docker.tar
<span class="c"># å®‰è£…docker</span>
<span class="nv">$ </span>apt <span class="nb">install </span>docker.io <span class="nt">-y</span>
<span class="c"># åˆ›å»ºdocker swarm</span>
<span class="nv">$ </span>docker swarm init <span class="nt">--advertise-addr</span> your_ip

â€‹<span class="sb">```</span>
Swarm initialized: current node <span class="o">(</span>s1fof4pev4rj8mzn0q8ymmqx4<span class="o">)</span> is now a manager.

To add a worker to this swarm, run the following <span class="nb">command</span>:

    docker swarm <span class="nb">join</span> <span class="nt">--token</span> SWMTKN-1-508f7r079pxy9ggos64nhm50dznkdmni4gafmj6aqhbr7hd86g-6pbu4jfmn3wm4hu00h1593s3q 192.168.0.1:2377

To add a manager to this swarm, run <span class="s1">'docker swarm join-token manager'</span> and follow the instructions.
â€‹<span class="sb">```</span>


<span class="c"># è¿›å…¥å…¶ä»–ä¸¤å°webæœåŠ¡å™¨</span>
<span class="nv">$ </span>docker swarm <span class="nb">join</span> <span class="nt">--token</span> SWMTKN-1-508f7r079pxy9ggos64nhm50dznkdmni4gafmj6aqhbr7hd86g-6pbu4jfmn3wm4hu00h1593s3q 192.168.0.1:2377

â€‹<span class="sb">```</span>
This node joined a swarm as a worker.
â€‹<span class="sb">```</span>

<span class="c"># cronæœåŠ¡å™¨æŸ¥çœ‹å„ä¸ªèŠ‚ç‚¹ä¿¡æ¯</span>
<span class="nv">$ </span>docker node <span class="nb">ls</span>

â€‹<span class="sb">```</span>
ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION
ium2q83ucn30m62q0oz6y0pq4     appweb1            Ready               Active                                  18.09.7
zz22kpep91y35v62s3yrvg7yp     appweb2            Ready               Active                                  18.09.7
s1fof4pev4rj8mzn0q8ymmqx4 <span class="k">*</span>   quene               Ready               Active              Leader              18.09.7
â€‹<span class="sb">```</span>

<span class="c"># ä¿®æ”¹conf/secrets.ymlä¸­çš„é˜Ÿåˆ—å¼€å…³</span>
â€‹<span class="sb">```</span>
	<span class="c"># job</span>
  schedule_job_enabled: <span class="nb">true</span>
â€‹<span class="sb">```</span>
</code></pre></div></div>

<h5 id="åˆ›å»ºdocker-swarmç›‘æ§">åˆ›å»ºDocker Swarmç›‘æ§</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å¯åŠ¨dockerç›‘æ§portainer</span>
<span class="nv">$ </span>docker stack deploy <span class="nt">--compose-file</span><span class="o">=</span>portainer-agent-stack.yml portainer
</code></pre></div></div>

<p>å…¶ä¸­<code class="highlighter-rouge">portainer-agent-stack.yml</code>çš„é…ç½®å¯ä»¥çœ‹<a href="https://portainer.readthedocs.io/en/latest/deployment.html">è¿™é‡Œ</a>ã€‚</p>

<h5 id="æ¥ä¸‹æ¥ç¬¬ä¸€æ¬¡éƒ¨ç½²ç™»é™†æœåŠ¡å™¨æ‹‰å–æœ€æ–°çš„é•œåƒ">æ¥ä¸‹æ¥ç¬¬ä¸€æ¬¡éƒ¨ç½²ï¼Œç™»é™†æœåŠ¡å™¨æ‹‰å–æœ€æ–°çš„é•œåƒ</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ç™»é™†ç§æœ‰docker registryä»“åº“</span>
<span class="nv">$ </span>docker login <span class="nt">-u</span> username <span class="nt">-p</span> <span class="nb">pwd </span>xxxxx.com:5000

<span class="c"># æ‹‰å–æœ€æ–°çš„é•œåƒ</span>
<span class="nv">$ </span>docker pull xxxxx.com:5000/app:1.0.0.master
</code></pre></div></div>

<h5 id="åˆ›å»ºé…ç½®æ–‡ä»¶å¹¶è¿›è¡Œéƒ¨ç½²">åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œå¹¶è¿›è¡Œéƒ¨ç½²</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># åˆ›å»ºdockeré…ç½®æ–‡ä»¶</span>
<span class="nv">$ </span>./scripts/init_config

<span class="c"># å¯åŠ¨å®¹å™¨éƒ¨ç½²</span>
<span class="nv">$ </span>docker stack deploy <span class="nt">--with-registry-auth</span> <span class="nt">-c</span> docker-compose.yml app_name

<span class="c"># æŸ¥çœ‹å®¹å™¨è¿è¡ŒçŠ¶æ€</span>
<span class="nv">$ </span>docker service <span class="nb">ls</span>
</code></pre></div></div>

<p>å…¶ä¸­<code class="highlighter-rouge">init_config</code>æ–‡ä»¶</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">cd</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/config
<span class="nv">conf_size</span><span class="o">=</span><span class="sb">`</span>docker config <span class="nb">ls</span>|grep database|wc <span class="nt">-l</span><span class="sb">`</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$conf_size</span> <span class="nt">-gt</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span>docker config <span class="nb">rm </span>database_conf <span class="se">\</span>
    <span class="o">&amp;&amp;</span> docker config <span class="nb">rm </span>mongoid_conf <span class="se">\</span>
    <span class="o">&amp;&amp;</span> docker config <span class="nb">rm </span>secrets_conf <span class="se">\</span>
    <span class="o">&amp;&amp;</span> docker config <span class="nb">rm </span>puma_conf <span class="se">\</span>
    <span class="o">&amp;&amp;</span> docker config <span class="nb">rm </span>sidekiq_conf <span class="se">\</span>
<span class="k">fi

</span>docker config create database_conf database.yml <span class="se">\</span>
  <span class="o">&amp;&amp;</span> docker config create mongoid_conf mongoid.yml <span class="se">\</span>
  <span class="o">&amp;&amp;</span> docker config create secrets_conf secrets.yml <span class="se">\</span>
  <span class="o">&amp;&amp;</span> docker config create puma_conf puma.rb <span class="se">\</span>
  <span class="o">&amp;&amp;</span> docker config create sidekiq_conf sidekiq.yml

</code></pre></div></div>

<p><code class="highlighter-rouge">docker config </code>å­å‘½ä»¤ï¼Œç”¨æ¥ç®¡ç†é›†ç¾¤ä¸­çš„é…ç½®ä¿¡æ¯ï¼Œæ— éœ€å°†é…ç½®æ–‡ä»¶æ”¾å…¥é•œåƒæˆ–æŒ‚è½½åˆ°å®¹å™¨ä¸­å°±å¯ä»¥å®ç°å¯¹æœåŠ¡çš„é…ç½®ã€‚</p>

<h5 id="å…³äºç›‘æ§portainerçš„ä½¿ç”¨">å…³äºç›‘æ§Portainerçš„ä½¿ç”¨</h5>

<ul>
  <li>åœ¨<code class="highlighter-rouge">Registries</code>æ–°å¢è‡ªå·±çš„ç§æœ‰é•œåƒä»“åº“</li>
  <li>æ¯æ¬¡æ›´æ–°å¯ä»¥å…ˆåœ¨<code class="highlighter-rouge">Images</code>ä¸‹æ‹‰å–æœ€æ–°çš„é•œåƒåˆ°å¯¹åº”çš„æœåŠ¡å™¨ä¸­</li>
  <li>æ›´æ–°å¯ä»¥è¿›å…¥<code class="highlighter-rouge">Stacks</code>ç‚¹å‡»å¯¹åº”çš„æœåŠ¡è¿›å»ï¼Œé€‰æ‹©å¹¶<code class="highlighter-rouge">Update</code>ï¼Œå¯å‹¾é€‰æ˜¯å¦ä½¿ç”¨æœ€æ–°çš„é•œåƒ</li>
  <li>é…ç½®æ–‡ä»¶å¯ä»¥åœ¨<code class="highlighter-rouge">Configs</code>ä¸­æŸ¥çœ‹</li>
  <li>æ—¥å¿—å¯ä»¥åœ¨<code class="highlighter-rouge">Services</code>ä¸­ç‚¹å‡»å¯¹åº”çš„æœåŠ¡è¿›å…¥ï¼Œç‚¹å‡»<code class="highlighter-rouge">Service logs</code>æŸ¥çœ‹æ—¥å¿—</li>
  <li>æ›´æ–°å¤±è´¥çš„æ—¥å¿—ï¼Œå¯ä»¥åœ¨<code class="highlighter-rouge">Stacks</code>ä¸­ç‚¹å‡»å¯¹åº”æœåŠ¡å™¨çš„æ—¥å¿—æŸ¥çœ‹</li>
</ul>

<h5 id="å…³äºé…ç½®æ–‡ä»¶çš„æ»šåŠ¨æ›´æ–°">å…³äºé…ç½®æ–‡ä»¶çš„æ»šåŠ¨æ›´æ–°</h5>

<p>å½“éœ€è¦ä¿®æ”¹configé…ç½®çš„å†…å®¹æ—¶ï¼Œåˆ›å»ºæ–°é…ç½®ï¼ˆä½¿ç”¨docker config createï¼‰ç„¶åæ›´æ–°æœåŠ¡ä»¥åˆ é™¤å…ˆå‰é…ç½®çš„configï¼Œå¹¶æ·»åŠ å¯¹æ–°é…ç½®æ˜¯ä¸€ç§å¸¸è§æ¨¡å¼ã€‚æœåŠ¡å‘½ä»¤<code class="highlighter-rouge">--config-rm</code>å’Œ<code class="highlighter-rouge">--config-add</code>:</p>

<p>æ¯”å¦‚æˆ‘ä¿®æ”¹äº†secrets.ymlï¼Œè€Œç°åœ¨åœ¨æ‰§è¡Œ<code class="highlighter-rouge">docker config ls</code>æ—¶å€™å·²ç»å­˜åœ¨secrets_conf</p>

<p>è¿™æ—¶å€™æˆ‘æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œé‡æ–°åˆ›å»ºä¸ªæ–°çš„é…ç½®ï¼Œæ¯”å¦‚åˆ›å»ºsecrets_conf_1
docker config create secrets_conf_1 config/secrets.yml</p>

<p>ç„¶åæ‰§è¡Œä¸‹é¢è¿›è¡Œconfigæ›´æ–°
docker service update â€“config-rm database_log_conf â€“config-add src=database_log_conf_1,target=/home/app/app_name/config/database_log.yml app_name</p>
:ET